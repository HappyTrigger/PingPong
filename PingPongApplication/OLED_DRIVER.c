/*
 * OLED_DRIVER.c
 *
 * Created: 17.09.2015 10:09:58
 *  Author: michalma
 */ 

#include <avr/pgmspace.h>
#include <string.h>
#include "OLED_DRIVER.h"
#include "PING_PONG_LIB.h"

static unsigned int position = 0;


const unsigned char PROGMEM font[95][5] = {
	{0b00000000,0b00000000,0b00000000,0b00000000,0b00000000}, //
	{0b00000000,0b00000000,0b01011110,0b00000000,0b00000000}, // !
	{0b00000000,0b00001110,0b00000000,0b00001110,0b00000000}, // "
	{0b00101000,0b01111100,0b00101000,0b01111100,0b00101000}, // #
	{0b00001000,0b01010100,0b01111100,0b01010100,0b00100000}, // $
	{0b00100110,0b00010000,0b00001000,0b01100100,0b00000000}, // %
	{0b00101000,0b01010100,0b00101000,0b01000000,0b00000000}, // &
	{0b00000000,0b00000000,0b00001110,0b00000000,0b00000000}, // '
	{0b00000000,0b00111100,0b01000010,0b00000000,0b00000000}, // (
	{0b00000000,0b01000010,0b00111100,0b00000000,0b00000000}, // )
	{0b00000000,0b01010100,0b00111000,0b01010100,0b00000000}, // *
	{0b00010000,0b00010000,0b01111100,0b00010000,0b00010000}, // +
	{0b00000000,0b10000000,0b01100000,0b00100000,0b00000000}, // ,
	{0b00010000,0b00010000,0b00010000,0b00010000,0b00000000}, // -
	{0b00000000,0b01100000,0b01100000,0b00000000,0b00000000}, // .
	{0b00100000,0b00010000,0b00001000,0b00000100,0b00000000}, // /
	{0b00000000,0b00111100,0b01000010,0b00111100,0b00000000}, // 0
	{0b00000000,0b01000100,0b01111110,0b01000000,0b00000000}, // 1
	{0b01000100,0b01100010,0b01010010,0b01001100,0b00000000}, // 2
	{0b00100010,0b01001010,0b01001010,0b00110110,0b00000000}, // 3
	{0b00011000,0b00010100,0b01111110,0b00010000,0b00000000}, // 4
	{0b00101110,0b01001010,0b01001010,0b00110010,0b00000000}, // 5
	{0b00111100,0b01001010,0b01001010,0b00110000,0b00000000}, // 6
	{0b00000010,0b01100010,0b00011010,0b00000110,0b00000000}, // 7
	{0b00110100,0b01001010,0b01001010,0b00110100,0b00000000}, // 8
	{0b00001100,0b01010010,0b01010010,0b00111100,0b00000000}, // 9
	{0b00000000,0b01101100,0b01101100,0b00000000,0b00000000}, // :
	{0b10000000,0b01101100,0b00101100,0b00000000,0b00000000}, // ;
	{0b00000000,0b00010000,0b00101000,0b01000100,0b00000000}, // <
	{0b00101000,0b00101000,0b00101000,0b00101000,0b00000000}, // =
	{0b00000000,0b01000100,0b00101000,0b00010000,0b00000000}, // >
	{0b00000000,0b00000100,0b01010010,0b00001100,0b00000000}, // ?
	{0b00111100,0b01000010,0b01011010,0b00011100,0b00000000}, // @
	{0b01111100,0b00010010,0b00010010,0b01111100,0b00000000}, // A
	{0b01111110,0b01001010,0b01001010,0b00110100,0b00000000}, // B
	{0b00111100,0b01000010,0b01000010,0b00100100,0b00000000}, // C
	{0b01111110,0b01000010,0b01000010,0b00111100,0b00000000}, // D
	{0b01111110,0b01001010,0b01001010,0b01000010,0b00000000}, // E
	{0b01111110,0b00001010,0b00001010,0b00000010,0b00000000}, // F
	{0b00111100,0b01000010,0b01010010,0b01110100,0b00000000}, // G
	{0b01111110,0b00001000,0b00001000,0b01111110,0b00000000}, // H
	{0b00000000,0b01000010,0b01111110,0b01000010,0b00000000}, // I
	{0b00100000,0b01000000,0b01000000,0b00111110,0b00000000}, // J
	{0b01111110,0b00011000,0b00100100,0b01000010,0b00000000}, // K
	{0b01111110,0b01000000,0b01000000,0b01000000,0b00000000}, // L
	{0b01111110,0b00001100,0b00001100,0b01111110,0b00000000}, // M
	{0b01111110,0b00001100,0b00110000,0b01111110,0b00000000}, // N
	{0b00111100,0b01000010,0b01000010,0b00111100,0b00000000}, // O
	{0b01111110,0b00010010,0b00010010,0b00001100,0b00000000}, // P
	{0b00111100,0b01100010,0b01000010,0b10111100,0b00000000}, // Q
	{0b01111110,0b00010010,0b00110010,0b01001100,0b00000000}, // R
	{0b00100100,0b01001010,0b01010010,0b00100100,0b00000000}, // S
	{0b00000000,0b00000010,0b01111110,0b00000010,0b00000000}, // T
	{0b00111110,0b01000000,0b01000000,0b00111110,0b00000000}, // U
	{0b00011110,0b01100000,0b01100000,0b00011110,0b00000000}, // V
	{0b01111110,0b00110000,0b00110000,0b01111110,0b00000000}, // W
	{0b01100110,0b00011000,0b00011000,0b01100110,0b00000000}, // X
	{0b00000000,0b00001110,0b01110000,0b00001110,0b00000000}, // Y
	{0b01100010,0b01010010,0b01001010,0b01000110,0b00000000}, // Z
	{0b00000000,0b01111110,0b01000010,0b01000010,0b00000000}, // [
	{0b00000100,0b00001000,0b00010000,0b00100000,0b00000000}, // "\"
	{0b00000000,0b01000010,0b01000010,0b01111110,0b00000000}, // ]
	{0b00000000,0b00000100,0b00000010,0b00000100,0b00000000}, // ^
	{0b01000000,0b01000000,0b01000000,0b01000000,0b00000000}, // _
	{0b00000000,0b00000010,0b00000100,0b00000000,0b00000000}, // `
	{0b00110000,0b01001000,0b00101000,0b01111000,0b00000000}, // a
	{0b01111110,0b01001000,0b01001000,0b00110000,0b00000000}, // b
	{0b00110000,0b01001000,0b01001000,0b00000000,0b00000000}, // c
	{0b00110000,0b01001000,0b01001000,0b01111110,0b00000000}, // d
	{0b00110000,0b01101000,0b01011000,0b00010000,0b00000000}, // e
	{0b00010000,0b01111100,0b00010010,0b00000100,0b00000000}, // f
	{0b01010000,0b10101000,0b10101000,0b10011000,0b00000000}, // g
	{0b01111110,0b00001000,0b00001000,0b01110000,0b00000000}, // h
	{0b00000000,0b01001000,0b01111010,0b01000000,0b00000000}, // i
	{0b00000000,0b01000000,0b10000000,0b01111010,0b00000000}, // j
	{0b01111110,0b00010000,0b00101000,0b01000000,0b00000000}, // k
	{0b00000000,0b01000010,0b01111110,0b01000000,0b00000000}, // l
	{0b01111000,0b00010000,0b00011000,0b01110000,0b00000000}, // m
	{0b01111000,0b00001000,0b00001000,0b01110000,0b00000000}, // n
	{0b00110000,0b01001000,0b01001000,0b00110000,0b00000000}, // o
	{0b11111000,0b01001000,0b01001000,0b00110000,0b00000000}, // p
	{0b00110000,0b01001000,0b01001000,0b11111000,0b00000000}, // q
	{0b01111000,0b00001000,0b00001000,0b00010000,0b00000000}, // r
	{0b01010000,0b01011000,0b01101000,0b00101000,0b00000000}, // s
	{0b00001000,0b00111110,0b01001000,0b01000000,0b00000000}, // t
	{0b00111000,0b01000000,0b01000000,0b01111000,0b00000000}, // u
	{0b00000000,0b00111000,0b01000000,0b00111000,0b00000000}, // v
	{0b01111000,0b01100000,0b01100000,0b01111000,0b00000000}, // w
	{0b01001000,0b00110000,0b00110000,0b01001000,0b00000000}, // x
	{0b00011000,0b10100000,0b01000000,0b00111000,0b00000000}, // y
	{0b01001000,0b01101000,0b01011000,0b01001000,0b00000000}, // z
	{0b00000000,0b00001000,0b00111100,0b01000010,0b00000000}, // {
	{0b00000000,0b00000000,0b01111110,0b00000000,0b00000000}, // |
	{0b00000000,0b01000010,0b00111100,0b00001000,0b00000000}, // }
	{0b00000100,0b00000010,0b00000100,0b00000010,0b00000000}, // ~
};

void init_oled(){
	write_c(0xae);    // display off
	write_c(0xa1);    //segment remap
	write_c(0xda);    //common pads hardware: alternative
	write_c(0x12);
	write_c(0xc8);    //common output scan direction:com63~com0
	write_c(0xa8);    //multiplex ration mode:63
	write_c(0x3f);
	write_c(0xd5);    //display divide ratio/osc. freq. mode
	write_c(0x80);
	write_c(0x81);    //contrast control
	write_c(0x50);
	write_c(0xd9);    //set pre-charge period
	write_c(0x21);
	write_c(0x20);    //Set Memory Addressing Mode
	write_c(0x00);
	write_c(0xdb);    //VCOM deselect level mode
	write_c(0x30);
	write_c(0xad);    //master configuration
	write_c(0x00);
	write_c(0xa4);    //out follows RAM content
	write_c(0xa6);    //set normal display
	write_c(0xaf);    // display on
}

void write_c(char command)
{
	volatile char *ext_oled = (char *) OLED_COMMAND_BASE_ADDR;
	ext_oled[0] = command;
}

void write_d(char data)
{
	volatile char *ext_oled = (char *) OLED_DATA_BASE_ADDR;
	ext_oled[0] = data;
}

void reset_position()
{
	write_c(0x21); // set column to 0
	write_c(0x00);
	write_c(0x7F);
	
	write_c(0x22); // set page to 0
	write_c(0x00);
	write_c(0x07);
}

void refresh_oled()
{
	reset_position();
	volatile char *ext_ram = (char *) OLED_BASE_SRAM_ADDRESS;
	unsigned char oled_value;
	
	for (int i = 0; i < OLED_ADDR_SPACE_LEN; i++)
	{
		oled_value = ext_ram[i];
		write_d(oled_value);
	}
}

void clear_oled()
{
	volatile char *ext_ram = (char *) OLED_BASE_SRAM_ADDRESS;
	
	for (int i = 0; i < OLED_ADDR_SPACE_LEN; i++)
	{
		ext_ram[i] = 0x00;
	}
}

int set_pixel(unsigned int x,unsigned int y)
{
	volatile char *ext_ram = (char *) OLED_BASE_SRAM_ADDRESS;
	
	if (x > 127)
	{
		return 1;
	}
	else if (y > 64)
	{
		return 1;
	}
	else
	{
		unsigned int page = y/8;
		unsigned int coloumn = page*128 + x;
		ext_ram[coloumn] |= (1 << (y % 8));
	}
}

int unset_pixel(unsigned int x,unsigned int y)
{
	volatile char *ext_ram = (char *) OLED_BASE_SRAM_ADDRESS;
	
	if (x > 127)
	{
		return 1;
	}
	else if (y > 64)
	{
		return 1;
	}
	else
	{
		unsigned int page = y/8;
		unsigned int column = page*128 + x;
		ext_ram[column] &= ~(1 << (y % 8));
	}
}

void print_char(char character)
{
	volatile char *ext_ram = (char *) OLED_BASE_SRAM_ADDRESS;
	
	for(int i=0; i<4;i++)
	{
		ext_ram[position] = pgm_read_word_near(&(font[character-32][i]));
		position++;
	}
}



void screensaver()
{
	static char x = 0;
	static char dir = 0;
	if (dir == 0)
	{
		x++;
		dir = x == 127 ? 1 : 0;
	}
	else
	{
		x--;
		dir = x == 0 ? 0 : 1;
	}

	
	for (int i = 0; i < 64; i++)
	{
		set_pixel(x, i);
	}
	refresh_oled();
	for (int i = 0; i < 64; i++)
	{
		unset_pixel(x, i);
	}
	_delay_ms(10);
}



int set_position(unsigned int column, unsigned int page)
{
	if (column > 32)
	{
		return 1;
	}
	else if (page > 8)
	{
		return 1;
	}
		
	position = page*128 + column*4;

}


int print_string(char* string)
{
	int lenght  = strlen(string);
	for(int i=0; i<lenght;i++){
		print_char(string[i]);
	}
}



